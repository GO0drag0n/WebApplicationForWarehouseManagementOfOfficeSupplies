@model ManageAccountViewModel
@{
    ViewData["Title"] = "Manage Account";
}

<div class="container my-4">

    <div class="row justify-content-center">
        <div class="col-12 text-center">
            <h2 class="fw-bold">Manage Your Account</h2>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-6 mb-3">
            <form asp-action="UpdateProfile" method="post" class="p-3 border rounded bg-light">
                <h4>Update Profile</h4>
                <hr />

                <div class="form-group mb-3">
                    <label asp-for="FirstName" class="form-label"></label>
                    <input asp-for="FirstName" class="form-control" />
                    <span asp-validation-for="FirstName" class="text-danger"></span>
                </div>

                <div class="form-group mb-3">
                    <label asp-for="LastName" class="form-label"></label>
                    <input asp-for="LastName" class="form-control" />
                    <span asp-validation-for="LastName" class="text-danger"></span>
                </div>

                <div class="form-group mb-3">
                    <label asp-for="Email" class="form-label"></label>
                    <input asp-for="Email" class="form-control" />
                    <span asp-validation-for="Email" class="text-danger"></span>
                </div>

                <button type="submit" class="btn btn-primary w-100">Update Profile</button>
            </form>
        </div>

        <div class="col-md-6">
            <form asp-action="ChangePassword" method="post" class="p-3 border rounded bg-light">
                <h4>Change Password</h4>
                <hr />

                <div class="form-group mb-3">
                    <label asp-for="CurrentPassword" class="form-label"></label>
                    <input asp-for="CurrentPassword" class="form-control" type="password" />
                    <span asp-validation-for="CurrentPassword" class="text-danger"></span>
                </div>

                <div class="form-group mb-3">
                    <label asp-for="NewPassword" class="form-label"></label>
                    <input asp-for="NewPassword" class="form-control" type="password" />
                    <span asp-validation-for="NewPassword" class="text-danger"></span>
                </div>

                <div class="form-group mb-3">
                    <label asp-for="ConfirmPassword" class="form-label"></label>
                    <input asp-for="ConfirmPassword" class="form-control" type="password" />
                    <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                </div>

                <button type="submit" class="btn btn-secondary w-100">Change Password</button>
            </form>

        </div>

        <div class="col-md-6">
            @if (Model.IsCompanyOwner)
            {
                <div class="p-3 border rounded bg-light">
                    <h4>Manage Your Company</h4>
                    <p><strong>Company Name:</strong> @Model.CompanyName</p>
                    <hr />
                    <a asp-controller="Company" asp-action="Manage" asp-route-id="@Model.CompanyId" class="btn btn-primary w-100 mb-2">Manage Company</a>
                    <a id="inviteWorkerButton" data-company-id="@Model.CompanyId" class="btn btn-secondary w-100 mb-2">Invite Worker</a>
                    <a asp-controller="Company" asp-action="Leave" asp-route-id="@Model.CompanyId" class="btn btn-danger w-100">Leave Company</a>
                </div>
            }
            else if (Model.IsCompanyWorker)
            {
                <div class="p-3 border rounded bg-light">
                    <h4>Your Company</h4>
                    <p><strong>Company Name:</strong> @Model.CompanyName</p>
                    <hr />
                    <a asp-controller="Company" asp-action="Leave" asp-route-id="@Model.CompanyId" class="btn btn-danger w-100">Leave Company</a>
                </div>
            }
            else
            {
                <form asp-action="JoinCompany" method="post" class="p-3 border rounded bg-light">
                    <h4>Join or Create a Company Client</h4>
                    <div class="form-group">
                        <label class="form-label">Enter the company code</label>
                        <input name="CompanyCode" class="form-control" />
                    </div>
                    <button type="submit" class="btn btn-primary w-100 mt-3">Join an existing Company Client</button>
                    <a asp-controller="Company" asp-action="Create" class="btn btn-primary w-100 mt-3">Create a Company Client</a>
                </form>
            }
        </div>
    </div>
</div>

<div class="modal fade" id="inviteWorkerModal" tabindex="-1" aria-labelledby="inviteWorkerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="inviteWorkerModalLabel">Company Code</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="companyCodeMessage"></p>
            </div>
            <div class="modal-footer">
                <button id="copyCompanyCodeButton" class="btn btn-primary">Copy Code</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const inviteWorkerButton = document.getElementById('inviteWorkerButton');
        const modalBody = document.getElementById('companyCodeMessage');
        const modal = new bootstrap.Modal(document.getElementById('inviteWorkerModal'));
        const copyButton = document.getElementById('copyCompanyCodeButton');

        let currentCompanyCode = ''; // To store the company code for copying

        inviteWorkerButton.addEventListener('click', function () {
            const companyId = inviteWorkerButton.getAttribute('data-company-id');

            console.log(`Fetching company code for ID: ${companyId}`); // Debugging output

            fetch(`/Account/GetCompanyCode?companyId=${companyId}`)
                .then(response => {
                    console.log("Response Status:", response.status); // Log response status
                    if (!response.ok) {
                        throw new Error(`Failed to fetch company code. Status: ${response.status}`);
                    }
                    return response.json(); // Parse JSON response
                })
                .then(data => {
                    console.log("Response Data:", data); // Debugging output
                    // Improved formatting
                    currentCompanyCode = data.companyId; // Save for copying
                    modalBody.innerHTML = `The company code for "<strong>${data.companyName}</strong>" is:<br><strong>${data.companyId}</strong>`;
                    modal.show();
                })
                .catch(error => {
                    modalBody.textContent = "An error occurred while fetching the company code.";
                    modal.show();
                    console.error("Error fetching company code:", error); // Debugging output
                });
        });

        copyButton.addEventListener('click', function () {
            if (currentCompanyCode) {
                navigator.clipboard.writeText(currentCompanyCode).then(() => {
                    
                }).catch(err => {
                    alert('Failed to copy company code. Please try again.');
                    console.error('Copy error:', err);
                });
            }
        });
    });



</script>
